trigger: none
 
pr:
  branches:
    include:
    - develop

pool:
  vmImage: ubuntu-latest
  name: Azure Pipelines
  demands: maven

parameters:
  MAVEN_CACHE_FOLDER: '$(HOME)/.m2/repository'
  MAVEN_CLEAN: true
  TEST_TIMEOUT_MINUTES: 5
  VERSION: '1.0.0-SNAPSHOT'

variables:
  - group: anypoint-platform-dev-variables
  - group: anypoint-platform-variables

jobs:
- job: packageAndTestJob
  displayName: 'Package and Test'
  steps:
    - task: Cache@2
      displayName: 'Cache Maven local repo'
      inputs:
        key: '"funcs" | maven | "$(Agent.OS)" | pom.xml'
        path: $(MAVEN_CACHE_FOLDER)

    - task: DownloadSecureFile@1
      displayName: 'Download Settings'
      inputs:
        secureFile: 'settings.xml'

    - task: Maven@4
      displayName: 'Package'
      inputs:
        goals: '$(if eq(parameters.MAVEN_CLEAN, true), 'clean ', '')package'
        mavenPomFile: 'pom.xml'
        options: '-s $(Agent.TempDirectory)/settings.xml'

    - task: Maven@4
      displayName: 'MUnit Test'
      inputs:
        goals: '$(if eq(parameters.MAVEN_CLEAN, true), 'clean ', '')test'
        mavenPomFile: 'pom.xml'
        options: '-s $(Agent.TempDirectory)/settings.xml'
      timeoutInMinutes: $(TEST_TIMEOUT)

- job: deployJob
  displayName: 'Deploy'
  dependsOn: packageAndTestJob
  steps:
    - task: DownloadSecureFile@1
      displayName: 'Download Settings'
      inputs:
        secureFile: 'settings.xml'
  
    - task: Bash@3
      displayName: 'Update pom.xml version for deploy'
      inputs:
        filePath: 'update-pom-version.sh'
      env:
        VERSION: '$(VERSION)'
        CURRENT_BRANCH: '$(Build.SourceBranchName)'

    - task: Maven@4
      displayName: "Deploy: Exchange"
      inputs:
        goals: 'deploy'
        mavenPomFile: 'pom.xml'
        options: "--settings $(Agent.TempDirectory)/settings.xml \
                  -DskipTests=true \
                  -Dconn.app.client.id=$(conn.app.client.id) \
                  -Dconn.app.client.secret=$(conn.app.client.secret)"

    - task: Maven@4
      displayName: "Deploy: Cloudhub"
      inputs:
        goals: 'deploy'
        mavenPomFile: 'pom.xml'
        options: "--settings $(Agent.TempDirectory)/settings.xml \
                  -DmuleDeploy \
                  -Denvironment=$(environment) \
                  -Dconn.app.client.id=$(conn.app.client.id) \
                  -Dconn.app.client.secret=$(conn.app.client.secret)"
